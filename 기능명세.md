# OpenEDR v1 스크립트별 완전 기능 명세 (누락 없이, 통합 분석/기능 요약)

현재 GitHub 리포지토[](https://github.com/yoon0416/openedr_v1)의 지정된 4개 스크립트(remote_evtx_collect.py, osquery_collect.py, analyze_evtx.py, main.py)를 기반으로, 각 py 파일에서 제공하는 **모든 분석 기능, 수집 기능, 오케스트레이션 기능, 오류 처리, 출력 생성 등을 누락 없이 통합 요약**합니다. 코드 전체를 분석한 결과, v2 파이프라인은 EVTX 수집(로그 추출/압축/다운로드/해제), 분석(Chainsaw + Sigma 매칭), 스위프(OSQuery 30+ 쿼리), 통합 저장(폴더 구조 자동화)을 one-click로 구현합니다. Linux 미지원, Windows 전용. 의존성: winrm, base64, zipfile, subprocess 등.

## 1. scripts/remote_evtx_collect.py: EVTX 로그 수집 및 압축 처리 기능
이 스크립트는 WinRM을 통해 원격 Windows 호스트에서 이벤트 로그(Security.evtx, System.evtx, Application.evtx)를 추출하고, ZIP 압축 후 Base64로 다운로드하며, 로컬 압축 해제를 제공합니다. **분석 기능**: 없음 (수집 전용). **기타 기능**: 임시 폴더 생성(C:\EDR_TEMP\exports), 타임스탬프+랜덤 문자열로 고유 파일명 생성(예: logs_20251211_143022_AB.zip), 오류 시 std_err 출력 및 None 반환. **출력**: ZIP 파일 + 압축 해제된 EVTX 폴더(예: report_root/evtx/extract_YYYYMMDD_HHMMSS). **Standalone 모드**: 콘솔 입력으로 테스트 실행, test_root 자동 생성. **전체 동작**: PS_SCRIPT로 wevtutil epl 실행 → Compress-Archive → build_b64_script로 Base64 변환 → download_zip으로 로컬 저장 → extract_evtx로 압축 해제.

## 2. scripts/osquery_collect.py: OSQuery 기반 시스템 포렌식 스위프 기능
이 스크립트는 WinRM으로 Osqueryi.exe를 호출해 30개 쿼리를 실행하며, 결과를 JSON으로 Base64 인코딩 후 로컬 저장합니다. **분석 기능**: 없음 (스냅샷 수집 전용, 하지만 쿼리 자체가 포렌식 분석 기반: 프로세스/cmdline/parent, 네트워크 연결/포트, 서비스/드라이버, 계정/그룹/로그온, 시작 프로그램/스케줄러, OS/패치/프로그램 정보, 디스크/마운트, 보안 제품, 레지스트리(Run 키, RDP 설정), DNS/인터페이스, USB(현재/히스토리), Chrome(확장/히스토리/쿠키, LIMIT 100), 공격 흔적(prefetch/shimcache/amcache/powershell_events/scripts, LIMIT 200)). **기타 기능**: 쿼리별 성공/실패 카운트, 실패 시 misc/osquery_errors.log에 기록(쿼리명 + 오류), UTF8 인코딩 후 Base64 처리, OSQUERY_PATH 하드코딩(C:\Program Files\osquery\osqueryi.exe). **출력**: report_root/osquery/{query_name}.json (30개 파일) + 오류 로그. **Standalone 모드**: 콘솔 입력으로 테스트, standalone_test 루트 생성. **전체 동작**: run_osquery_query로 PS 명령 실행(OSQuery --json → Base64) → 반복 루프로 모든 OSQUERY_QUERIES 처리 → 요약 출력.

## 3. scripts/analyze_evtx.py: Chainsaw + Sigma EVTX 위협 탐지 분석 기능
이 스크립트는 수집된 EVTX를 Chainsaw CLI로 Sigma 규칙에 매칭해 위협 이벤트를 탐지하고, JSON 보고서를 생성합니다. **분석 기능**: Sigma 규칙 기반 이벤트 매칭(특권 상승, 측면 이동, 원격 코드 실행 등; windows/rules 폴더 전체 적용), 매핑 파일(sigma-event-logs-all.yml)으로 로그 타입 매칭, hunt 모드로 이벤트 필터링(rule_id, 타임스탬프, 로그 ID, 설명 등 상세 출력). **기타 기능**: 입력 경로 검증(EVTX dir, sigma_dir, mapping_file 존재 확인), subprocess.run으로 chainsaw hunt 실행(옵션: --sigma, --mapping, --output), CalledProcessError 시 returncode/명령어 로그 저장(misc/chainsaw_error.log). **출력**: report_root/chainsaw/chainsaw_report.json (매칭 이벤트 배열). **Standalone 모드**: 콘솔 입력으로 EVTX 경로 지정, standalone_test 루트 생성. **전체 동작**: prepare_chainsaw_output으로 출력 경로 생성 → cmd 배열 구성 → subprocess 실행 → 성공 시 JSON 경로 반환.

## 4. scripts/main.py: v2 통합 파이프라인 오케스트레이션 및 증거 집계 기능
이 스크립트는 위 3개 모듈을 순차적으로 호출하는 메인 워크플로를 제공하며, 증거 폴더 구조를 자동화합니다. **분석 기능**: 없음 (오케스트레이션 전용, 하지만 파이프라인 결과 통합으로 EVTX 분석 + OSQuery 스위프를 연결해 전체 시스템 인시던트 타임라인 집계 가능). **기타 기능**: prepare_v2_report_root로 타임스탬프 기반 루트 생성(~/openedr_v1/evidence/v2_report/{username}_{YYYYMMDD_HHMM}, 서브폴더: evtx/chainsaw/osquery/misc 자동 생성, 한국시간 UTC+9 사용), getpass로 비밀번호 입력, 각 단계 실패 시 sys.exit(1)로 중단, [1/3]/[2/3]/[3/3] 진행 표시. **출력**: 통합 루트 경로 + 요약(EVTX 폴더, Chainsaw JSON, OSQuery 폴더 목록 출력). **Standalone 모드**: 없음 (직접 main() 실행). **전체 동작**: 입력 수집 → report_root 생성 → remote_evtx_collect.run() 호출(EVTX) → analyze_evtx.run(EVTX dir) → osquery_collect.run() → Final Summary 출력.

## 전체 시스템 기능 요약 (누락 없이)
- **수집 기능**: EVTX 3개 로그 전체 + OSQuery 30개 쿼리(프로세스/네트워크/계정/레지스트리/USB/Chrome/공격 흔적 등 포괄적 스냅샷).
- **분석 기능**: Sigma/Chainsaw로 EVTX 이벤트 매칭(위협 TTP 탐지), OSQuery 쿼리로 시스템 상태 분석 기반.
- **집계/보고 기능**: JSON 출력(개별 + 통합 루트), 오류 로그 자동 저장, 폴더 구조화( evidence/v2_report/{timestamp}/evtx/ + chainsaw/ + osquery/ + misc/ ).
- **오류 처리**: WinRM 연결 실패/실행 오류/경로 검증 시 로그 저장 + None/종료 반환.
- **실행 환경**: Python 3.x, WinRM/Osquery/Chainsaw 설치 필요. v3(LLM) 미구현.
- **조사 가능 범위**: 로그인/프로세스 생성 타임라인, 의심 연결/레지스트리 변경, PowerShell 실행 이력 등 DFIR 전체 커버 (MITRE ATT&CK 매핑 준비).

이 명세는 코드 전체(imports, 변수, 함수, if __name__ == "__main__" 포함)를 기반으로 하며, v2 완료 상태를 반영합니다. 추가 구현(merge.py 등) 시 업데이트 필요.
