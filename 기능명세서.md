# Mini-EDR v2.1.0 기능 명세서  
> **Detection Capability Specification — version 2.1.0**  
본 문서는 Mini-EDR v2.x 아키텍처 기반으로  
**현재 수집·탐지 가능한 모든 데이터(누락 확인필요 공격테스트 예정)**와  
**어떤 스크립트에서 어떻게 구현되는지**를 상세히 정의한 공식 기능 명세서이다.

---

# 0. 전체 파이프라인 구성 개요

Mini-EDR v2.1은 다음 4개의 독립 엔진이  
하나의 Evidence Root 아래에서 통합 동작한다.

| 단계 | 엔진 | 스크립트 | 설명 |
|------|-------|-----------|------|
| 1 | **EVTX 원격 수집** | `remote_evtx_collect.py` | WinRM 기반 이벤트 로그 수집 |
| 2 | **Sigma + Chainsaw 탐지** | `analyze_evtx.py` | 행위 기반 위협 탐지 및 MITRE 매핑 |
| 3 | **OSQuery 시스템 스윕** | `osquery_collect.py` | 시스템·네트워크·프로세스·레지스트리 상태 수집 |
| 4 | **Velociraptor DFIR Query** | `velociraptor_collect.py` | 45개 이상의 고급 포렌식 아티팩트 수집 |

Evidence 저장 구조:
```
v2_report/<username_timestamp>/
├── evtx/
├── chainsaw/
│   └── chainsaw_report.json
├── osquery/
│   └── *.json
└── velociraptor/
    └── *.jsonl (총 45개 이상)
```

---

# 1. EVTX 원격 수집 (remote_evtx_collect.py)

## 1.1 기능 개요
- WinRM(PowerShell Remoting)을 이용하여  
  **Security / System / Application** EVTX 수집
- ZIP 패키징 → Linux 서버로 전송
- 이후 Chainsaw 탐지엔진의 입력으로 사용
- 저장 경로: `v2_report/<user>/evtx/`

## 1.2 수집되는 로그 종류
| 로그 종류 | 설명 |
|----------|------|
| Security.evtx | 계정·로그온·권한 상승·정책 변경 |
| System.evtx | 서비스 시작/중지, 드라이버 로드 |
| Application.evtx | 애플리케이션 이벤트 |
| PowerShell 이벤트 | WinRM 실행 기반 PS 활동 |

## 1.3 주요 구현 로직
- `wevtutil epl` 자동 실행
- 파일명 충돌 방지(Timestamp + Random)
- Windows 경로 → ZIP 파일 정규화

---

# 2. Chainsaw + Sigma 기반 이벤트 분석 (analyze_evtx.py)

## 2.1 기능 개요
수집된 EVTX를 기반으로  
**Sigma 룰셋 + Chainsaw 엔진**을 사용하여  
공격 행위를 탐지하고 JSON 보고서를 생성한다.

결과물: `chainsaw/chainsaw_report.json`

## 2.2 탐지 가능한 공격 행위
| 유형 | 설명 |
|------|------|
| 권한 상승 | Admin 그룹 편입, 고급 권한 변경 |
| 계정 공격 | RDP Brute-force, 반복 로그인 실패 |
| LOLBins 실행 | rundll32, regsvr32, mshta, powershell -nop 등 |
| 원격 코드 실행 | WinRM, WMI, PSRemoting |
| Persistence | 서비스 생성/변경, RunKey, 스케줄러 |
| 이벤트 로그 조작 | Security 로그 삭제/비활성화 |
| Shadow Copy 조작 | 랜섬웨어 초기 단계 |
| PowerShell 공격 | Base64 payload, obfuscated 명령 |

## 2.3 탐지 엔진 구성
- Sigma rules: `tools/sigma/rules/windows/`
- Chainsaw YAML mapping:  
  `tools/chainsaw/mappings/sigma-event-logs-all.yml`
- 실행 스크립트: `analyze_evtx.py`

---

# 3. OSQuery 기반 시스템 포렌식 스윕 (osquery_collect.py)

## 3.1 기능 개요
Windows OSQuery를 원격 실행하여  
**프로세스 / 네트워크 / 계정 / 레지스트리 / 서비스 / 드라이버 / USB / 브라우저 활동**  
등 시스템 전체 상태를 JSON으로 수집한다.

결과물 저장: `osquery/*.json`

---

## 3.2 OSQuery 전체 수집 항목

### A. 프로세스 / 네트워크
| 테이블 | 설명 |
|--------|------|
| processes | 프로세스 목록 |
| process_open_sockets | 프로세스별 소켓 |
| connections | 네트워크 연결 |
| listening_ports | 열린 포트 |

### B. 서비스 / 드라이버
| 테이블 | 설명 |
|--------|------|
| services | 서비스 정보 |
| drivers | 드라이버 |
| kernel_drivers | 커널 드라이버 |

### C. 계정 / 인증
| 테이블 | 설명 |
|--------|------|
| users | 사용자 계정 |
| groups | 그룹 |
| user_groups | 계정-그룹 매핑 |
| logged_in_users | 현재 로그인 |
| logon_sessions | 세션 정보 |

### D. 지속성(Persistence)
| 테이블 | 설명 |
|--------|------|
| startup_items | 자동 실행 프로그램 |
| scheduled_tasks | 예약 작업 |
| registry_run_hklm/hkcu | RunKey 기반 지속성 |

### E. 시스템 정보
| 테이블 | 설명 |
|--------|------|
| os_version | OS 버전 |
| system_info | 모델/BIOS |
| patches | 설치된 패치 |
| programs | 설치된 프로그램 |

### F. 파일시스템
| 테이블 | 설명 |
|--------|------|
| disks | 디스크 |
| logical_drives | 논리 드라이브 |
| mounts | 마운트된 볼륨 |

### G. 보안 제품 상태
| 테이블 | 설명 |
|--------|------|
| windows_security_products | AV/EDR 상태 |

### H. 네트워크 환경
| 테이블 | 설명 |
|--------|------|
| dns_resolvers | DNS 설정 |
| interface_addresses | NIC 설정 |

### I. USB & 주변기기
| 테이블 | 설명 |
|--------|------|
| usb_devices | USB 목록 |
| usb_devices_history | USB 이력 |

### J. Chrome 포렌식
| 테이블 | 설명 |
|--------|------|
| chrome_extensions | 확장 프로그램 |
| chrome_history | 방문 기록 |
| chrome_cookies | 쿠키 |

### K. DFIR 실행 흔적 테이블
| 테이블 | 설명 |
|--------|------|
| prefetch | 실행 흔적 |
| shimcache | AppCompatCache |
| amcache | Install/Execution DB |
| powershell_events | Powershell 로그 |
| powershell_scripts | 스크립트 이력 |

---

# 4. Velociraptor 기반 고급 DFIR 아티팩트 수집 (v2.1.0)

## 4.1 기능 개요
Velociraptor의 **Query Mode(VQL)**를 직접 호출하여  
**총 45개 이상의 고급 포렌식 아티팩트**를 JSONL로 수집한다.

스크립트: `velociraptor_collect.py`

저장 경로:
```
v2_report/<user>/velociraptor/*.jsonl
```

---

## 4.2 Velociraptor 전체 수집 아티팩트 목록

### A. 실행 흔적
- Prefetch  
- ShimCache  
- Amcache  
- JumpLists  
- LNK Files  
- RecentDocs  

### B. 파일시스템 포렌식
- MFT  
- USN Journal  
- RecycleBin  

### C. 브라우저 포렌식 (Chrome/Edge)
- History  
- Downloads  
- Cookies  

### D. 이벤트 로그
- EvtxFast  
- Security / System / Application  
- PowerShell  
- RemoteDesktop  

### E. 네트워크/기기 흔적
- USBDevices  
- DNSCache  
- FirewallLogs  
- RDPConnections  

### F. 시스템/레지스트리
- Autoruns  
- RunKeys HKCU/HKLM  
- StartupApproved  
- InstalledPrograms  
- Shellbags  
- SRUM  

### G. 시스템 구성
- Processes  
- Services  
- Drivers  
- Netstat  
- Installed Patches  
- OS Info  

---

## 4.3 주요 Velociraptor VQL 쿼리 (발췌)

```vql
SELECT * FROM Artifact.Windows.Execution.Prefetch();
SELECT * FROM Artifact.Windows.Registry.AppCompatCache();
SELECT * FROM Artifact.Windows.Registry.AmCache();
SELECT * FROM Artifact.Windows.Forensics.JumpLists();
SELECT * FROM Artifact.Windows.NTFS.MFT();
SELECT * FROM Artifact.Windows.NTFS.Usn();
SELECT * FROM Artifact.Windows.Persistence.Autoruns();
SELECT * FROM Artifact.Windows.System.Processes();
SELECT * FROM Artifact.Windows.System.Services();
SELECT * FROM Artifact.Windows.Network.Netstat();
```

---

# 5. 전체 파이프라인 오케스트레이션 (main.py)

## 5.1 실행 순서
```
1) WinRM 기반 EVTX 수집
2) Chainsaw + Sigma 위협 탐지
3) OSQuery 시스템 스윕
4) Velociraptor DFIR Query
5) Evidence Root에 통합 저장
```

## 5.2 Evidence 구조
```
v2_report/<user_timestamp>/
├── evtx/
├── chainsaw/
├── osquery/
└── velociraptor/
```

---

# 6. 스크립트 기능 요약

| 기능 | 스크립트 | 설명 |
|------|-----------|------|
| 원격 EVTX 수집 | `remote_evtx_collect.py` | WinRM → EVTX ZIP Export |
| 이벤트 탐지 | `analyze_evtx.py` | Sigma 룰 기반 위협 탐지 |
| 시스템 상태 수집 | `osquery_collect.py` | OSQuery Sweep |
| DFIR 아티팩트 수집 | `velociraptor_collect.py` | 45종 포렌식 JSONL |
| 전체 파이프라인 실행 | `main.py` | evidence root 생성 및 통합 |

---

# **결론 — Mini-EDR v2.1.0**
Mini-EDR v2.1은 다음 3개의 분석 축을 모두 통합한 **하이브리드 EDR**이다.

### ✔ 행위 기반 탐지  
EVTX + Sigma + Chainsaw

### ✔ 상태 기반 시스템 스캔  
OSQuery Sweep

### ✔ 고급 DFIR 아티팩트  
Velociraptor Query Mode (45종)

즉, **경량 EDR + 초급 SIEM + 중급 디지털포렌식 엔진**이 하나의 파이프라인으로 자동화된 형태의 완전한 Mini-EDR이 완성되었다.

